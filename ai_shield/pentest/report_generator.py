"""Generate markdown and HTML reports for pentest executions."""

from __future__ import annotations

import html
import logging
from datetime import datetime
from pathlib import Path
from typing import List

from ai_shield.pentest.vulnerability_analyzer import VulnerabilityRecord

logger = logging.getLogger(__name__)


class ReportGenerator:
    """Create report artifacts for security reviews."""

    def generate_markdown(self, records: List[VulnerabilityRecord], summary: dict) -> str:
        """Build a markdown report string."""
        lines = [
            "# Deriv AI Shield Pentest Report",
            "",
            f"Generated: {datetime.utcnow().isoformat()}Z",
            "",
            "## Summary",
            f"- Overall vulnerability score: **{summary.get('overall_score', 0.0)}**",
            f"- Blocked attack rate: **{summary.get('blocked_rate', 0.0)}**",
            f"- Critical findings: **{summary.get('critical_findings', 0)}**",
            f"- Total tests: **{summary.get('total_tests', 0)}**",
            "",
            "## Findings",
            "| Category | Severity | Blocked | Vulnerability Score | Payload |",
            "|---|---:|:---:|---:|---|",
        ]
        for record in records:
            lines.append(
                f"| {record.category} | {record.severity} | {record.blocked} | {record.vulnerability_score} | {record.payload} |"
            )
        return "\n".join(lines)

    def generate_html(self, markdown_report: str) -> str:
        """Build a minimal HTML report wrapper from markdown plaintext."""
        escaped = html.escape(markdown_report)
        return (
            "<html><head><title>Deriv AI Shield Report</title></head>"
            "<body><h1>Deriv AI Shield Pentest Report</h1>"
            f"<pre>{escaped}</pre></body></html>"
        )

    def save_reports(self, markdown_report: str, html_report: str, output_dir: str = "reports") -> dict:
        """Persist markdown and HTML reports to disk."""
        try:
            Path(output_dir).mkdir(parents=True, exist_ok=True)
            timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
            md_path = Path(output_dir) / f"pentest_report_{timestamp}.md"
            html_path = Path(output_dir) / f"pentest_report_{timestamp}.html"
            md_path.write_text(markdown_report, encoding="utf-8")
            html_path.write_text(html_report, encoding="utf-8")
            logger.info("Saved reports: %s and %s", md_path, html_path)
            return {"markdown": str(md_path), "html": str(html_path)}
        except Exception as exc:  # pragma: no cover
            logger.exception("Failed to save reports: %s", exc)
            return {"markdown": "", "html": ""}
